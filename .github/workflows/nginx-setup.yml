name: Manual Nginx Setup

description: 'Настройка nginx на сервере через SSH вручную'

on:
  workflow_dispatch:

jobs:
  setup-nginx:
    runs-on: ubuntu-latest
    steps:
      - name: Подключиться по SSH и настроить nginx
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            sudo apt update
            sudo apt install -y nginx certbot python3-certbot-nginx
            # HTTP config
            sudo bash -c "echo -e 'server {\n    listen 80;\n    server_name skillchecker.tech www.skillchecker.tech;\n    location / {\n        proxy_pass http://localhost:5005;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade \$http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n        proxy_set_header Host \$host;\n        proxy_set_header X-Real-IP \$remote_addr;\n        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \$scheme;\n    }\n}' > /etc/nginx/sites-available/skillchecker.tech"
            # Получить сертификаты
            sudo certbot --nginx --non-interactive --agree-tos --redirect -m brov.ko@ya.ru -d skillchecker.tech -d www.skillchecker.tech
            # HTTPS config (добавляется только если сертификаты получены)
            if [ -f /etc/letsencrypt/live/skillchecker.tech/fullchain.pem ] && [ -f /etc/letsencrypt/live/skillchecker.tech/privkey.pem ]; then
              sudo bash -c "echo -e 'server {\n    listen 443 ssl;\n    server_name skillchecker.tech www.skillchecker.tech;\n    ssl_certificate /etc/letsencrypt/live/skillchecker.tech/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/skillchecker.tech/privkey.pem;\n    include /etc/letsencrypt/options-ssl-nginx.conf;\n    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;\n    location / {\n        proxy_pass http://localhost:5005;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade \$http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n        proxy_set_header Host \$host;\n        proxy_set_header X-Real-IP \$remote_addr;\n        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \$scheme;\n    }\n}' >> /etc/nginx/sites-available/skillchecker.tech"
            fi
            echo "==== Содержимое nginx-конфига ===="
            cat /etc/nginx/sites-available/skillchecker.tech
            sudo ln -sf /etc/nginx/sites-available/skillchecker.tech /etc/nginx/sites-enabled/skillchecker.tech
            sudo nginx -t
            sudo systemctl reload nginx
            sudo nginx -t
            sudo systemctl reload nginx
            echo "nginx + HTTPS настроен для skillchecker.tech -> localhost:5005"
